const teremokTest = {
    questions: [
        {
            id: 1,
            text: "–ö–∞–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –Ω–æ–≤—ã–º –∑–∞–¥–∞—á–∞–º?",
            options: [
                { text: "–ñ–¥–µ—Ç —á–µ—Ç–∫–∏—Ö —É–∫–∞–∑–∞–Ω–∏–π, —Å–∞–º –Ω–µ –ø—Ä–æ—è–≤–ª—è–µ—Ç –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É", type: "bird" },
                { text: "–°–ø—Ä–∞—à–∏–≤–∞–µ—Ç: ¬´–ê —á—Ç–æ –º–Ω–µ –∑–∞ —ç—Ç–æ –±—É–¥–µ—Ç?¬ª", type: "hamster" },
                { text: "–ë–µ—Ä–µ—Ç—Å—è, –µ—Å–ª–∏ —ç—Ç–æ –ø–æ–≤—ã—Å–∏—Ç –µ–≥–æ –≤–ª–∏—è–Ω–∏–µ –∏–ª–∏ —Å—Ç–∞—Ç—É—Å", type: "fox" },
                { text: "–ò–∑—É—á–∞–µ—Ç –∑–∞–¥–∞—á—É –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —Ä–µ—à–µ–Ω–∏–µ", type: "profi" }
            ]
        },
        {
            id: 2,
            text: "–ö–∞–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –≤–µ–¥–µ—Ç —Å–µ–±—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö?",
            options: [
                { text: "–ü—Ä—è—á–µ—Ç –æ—à–∏–±–∫—É –∏–ª–∏ –æ–±–≤–∏–Ω—è–µ—Ç –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞", type: "bird" },
                { text: "–ü–µ—Ä–µ–∂–∏–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∑–∞ —Å–≤–æ–π —à—Ç—Ä–∞—Ñ", type: "hamster" },
                { text: "–ò—â–µ—Ç –≤–∏–Ω–æ–≤–∞—Ç–æ–≥–æ, –≤—ã–∫—Ä—É—á–∏–≤–∞–µ—Ç—Å—è", type: "fox" },
                { text: "–ü—Ä–∏–∑–Ω–∞–µ—Ç, –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –∏ –¥–µ–ª–∞–µ—Ç –≤—ã–≤–æ–¥—ã", type: "profi" }
            ]
        },
        {
            id: 3,
            text: "–ß—Ç–æ –º–æ—Ç–∏–≤–∏—Ä—É–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –ª—É—á—à–µ?",
            options: [
                { text: "–°—Ç—Ä–∞—Ö –Ω–∞–∫–∞–∑–∞–Ω–∏—è –∏–ª–∏ —É–≤–æ–ª—å–Ω–µ–Ω–∏—è", type: "bird" },
                { text: "–ü—Ä–µ–º–∏—è –∏–ª–∏ –±–æ–Ω—É—Å", type: "hamster" },
                { text: "–ü—É–±–ª–∏—á–Ω–∞—è –ø–æ—Ö–≤–∞–ª–∞, –¥–æ–ª–∂–Ω–æ—Å—Ç—å, –≤–ª–∞—Å—Ç—å", type: "fox" },
                { text: "–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –∑–∞–¥–∞—á–∏ –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–æ—Å—Ç", type: "profi" }
            ]
        },
        {
            id: 4,
            text: "–ö–∞–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç —Å –∫–æ–ª–ª–µ–≥–∞–º–∏?",
            options: [
                { text: "–î–µ—Ä–∂–∏—Ç—Å—è –æ–±–æ—Å–æ–±–ª–µ–Ω–Ω–æ –∏–ª–∏ ¬´–∫—É—á–∫—É–µ—Ç—Å—è¬ª —Å —Ç–∞–∫–∏–º–∏ –∂–µ", type: "bird" },
                { text: "–û–±—â–∞–µ—Ç—Å—è, –µ—Å–ª–∏ —ç—Ç–æ –≤—ã–≥–æ–¥–Ω–æ", type: "hamster" },
                { text: "–ü–ª–µ—Ç–µ—Ç –∏–Ω—Ç—Ä–∏–≥–∏, —Å–æ–∑–¥–∞–µ—Ç –∫–æ–∞–ª–∏—Ü–∏–∏", type: "fox" },
                { text: "–ü–æ–º–æ–≥–∞–µ—Ç, –¥–µ–ª–∏—Ç—Å—è –æ–ø—ã—Ç–æ–º, —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –∫–æ–º–∞–Ω–¥—É", type: "profi" }
            ]
        },
        {
            id: 5,
            text: "–û—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ —Ä–∞–±–æ—á–µ–º—É –≤—Ä–µ–º–µ–Ω–∏",
            options: [
                { text: "–û–ø–∞–∑–¥—ã–≤–∞–µ—Ç, –∂–¥–µ—Ç –∫–æ–Ω—Ü–∞ —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è", type: "bird" },
                { text: "–°–∏–¥–∏—Ç –æ—Ç –∑–≤–æ–Ω–∫–∞ –¥–æ –∑–≤–æ–Ω–∫–∞, –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏ —Ç–æ–ª—å–∫–æ –∑–∞ –¥–µ–Ω—å–≥–∏", type: "hamster" },
                { text: "–ò–º–∏—Ç–∏—Ä—É–µ—Ç –±—É—Ä–Ω—É—é –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å", type: "fox" },
                { text: "–†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –Ω–µ —Å–º–æ—Ç—Ä–∏—Ç –Ω–∞ —á–∞—Å—ã", type: "profi" }
            ]
        }
    ],
    
    currentQuestionIndex: 0,
    scores: {
        bird: 0,
        hamster: 0,
        fox: 0,
        profi: 0
    },

    init: function() {
        this.cacheDOM();
        this.bindEvents();
    },

    cacheDOM: function() {
        this.modal = document.getElementById('testModal');
        this.container = document.getElementById('testContainer');
        this.questionCard = document.getElementById('testQuestionCard');
        this.progressBar = document.getElementById('testProgressBar');
        this.resultContainer = document.getElementById('testResultContainer');
        this.telegramBlock = document.getElementById('testTelegramBlock');
    },

    bindEvents: function() {
        // Event delegation for dynamically created buttons
        if (this.questionCard) {
            this.questionCard.addEventListener('click', (e) => {
                if (e.target.classList.contains('test-option-btn')) {
                    const type = e.target.getAttribute('data-type');
                    this.handleAnswer(type);
                }
            });
        }
    },

    startTest: function() {
        this.currentQuestionIndex = 0;
        this.scores = { bird: 0, hamster: 0, fox: 0, profi: 0 };
        this.container.style.display = 'block';
        this.resultContainer.style.display = 'none';
        this.telegramBlock.style.display = 'none';
        this.renderQuestion();
    },

    renderQuestion: function() {
        const question = this.questions[this.currentQuestionIndex];
        const progress = ((this.currentQuestionIndex) / this.questions.length) * 100;
        
        this.progressBar.style.width = `${progress}%`;

        let html = `
            <div class="test-question-number">–í–æ–ø—Ä–æ—Å ${this.currentQuestionIndex + 1} –∏–∑ ${this.questions.length}</div>
            <h3 class="test-question-text">${question.text}</h3>
            <div class="test-options">
        `;

        question.options.forEach(option => {
            html += `<button class="test-option-btn" data-type="${option.type}">${option.text}</button>`;
        });

        html += `</div>`;
        this.questionCard.innerHTML = html;
    },

    handleAnswer: function(type) {
        if (this.scores.hasOwnProperty(type)) {
            this.scores[type]++;
        }

        this.currentQuestionIndex++;

        if (this.currentQuestionIndex < this.questions.length) {
            this.renderQuestion();
        } else {
            this.showResult();
        }
    },

    showResult: function() {
        this.container.style.display = 'none';
        this.resultContainer.style.display = 'block';
        this.telegramBlock.style.display = 'flex'; // Show Telegram block

        const winner = Object.keys(this.scores).reduce((a, b) => this.scores[a] > this.scores[b] ? a : b);
        
        const resultData = {
            bird: { title: "–ü—Ç–∏—Ü–∞", icon: "üê¶", desc: "–°–æ—Ç—Ä—É–¥–Ω–∏–∫ —Ç—Ä–µ–±—É–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è. –ú–æ—Ç–∏–≤–∞—Ü–∏—è ‚Äî —Å—Ç—Ä–∞—Ö –Ω–∞–∫–∞–∑–∞–Ω–∏—è." },
            hamster: { title: "–•–æ–º—è–∫", icon: "üêπ", desc: "–°–æ—Ç—Ä—É–¥–Ω–∏–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∑–∞ –¥–µ–Ω—å–≥–∏. –ú–æ—Ç–∏–≤–∞—Ü–∏—è ‚Äî –ª–∏—á–Ω–∞—è –≤—ã–≥–æ–¥–∞." },
            fox: { title: "–õ–∏—Å–∞", icon: "ü¶ä", desc: "–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –∏—â–µ—Ç –≤–ª–∞—Å—Ç–∏ –∏ —Å—Ç–∞—Ç—É—Å–∞. –ú–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–µ–Ω, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç–∏." },
            profi: { title: "–ü—Ä–æ—Ñ–∏", icon: "ü¶Å", desc: "–ù–∞–¥–µ–∂–Ω—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫. –ú–æ—Ç–∏–≤–∞—Ü–∏—è ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–∏–∑–º –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç." }
        };

        const result = resultData[winner];

        this.resultContainer.innerHTML = `
            <div class="test-result-card">
                <div class="test-result-icon">${result.icon}</div>
                <h3>–í–∞—à —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ: ${result.title}</h3>
                <p>${result.desc}</p>
                <div class="test-result-chart">
                    ${this.renderChart()}
                </div>
            </div>
        `;

        this.saveResult(winner);
    },

    renderChart: function() {
        // Simple visual representation of scores
        let html = '<div class="result-bars">';
        const maxScore = Math.max(...Object.values(this.scores));
        
        for (const [type, score] of Object.entries(this.scores)) {
            const height = maxScore > 0 ? (score / maxScore) * 100 : 0;
            const labels = { bird: "–ü—Ç–∏—Ü–∞", hamster: "–•–æ–º—è–∫", fox: "–õ–∏—Å–∞", profi: "–ü—Ä–æ—Ñ–∏" };
            html += `
                <div class="result-bar-item">
                    <div class="result-bar-fill" style="height: ${height}px;"></div>
                    <span class="result-bar-label">${labels[type]}</span>
                </div>
            `;
        }
        html += '</div>';
        return html;
    },

    saveResult: function(result) {
        // Mock database save
        console.log("Saving result to DB:", result, this.scores);
        // Here you would typically fetch() to your backend
        // fetch('/api/save-test', { method: 'POST', body: JSON.stringify({ result, scores: this.scores }) });
    }
};

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    teremokTest.init();
});

// Expose start function globally so it can be called from the form
window.startTeremokTest = function() {
    teremokTest.startTest();
};
